# WARNING: This file is autogenerated - changes will be overwritten when regenerated by https://github.com/pulumi/ci-mgmt

name: Upgrade bridge
on:
  repository_dispatch:
    types:
      - upgrade-bridge
      - upgrade-bridge-test
  workflow_dispatch:
    inputs:
      kind:
        description: Overrides the kind of upgrade. Must be one of `all`, `bridge`, `provider`, `code`, `pf`, or `pulumi`.
        required: false
        type: string
        default: "bridge"
      target-bridge-version:
        description: pulumi-terraform-bridge version or hash reference
        required: false
        type: string
        default: "latest"
      target-pulumi-version:
        description: |
             Set the version of `pulumi/pkg` and `pulumi/sdk` to depend on for bridged providers. Currently,
             these versions inform the linked runtime and SDK generation in all languages except Java. Valid
             options are:
             - "": Use the same version as pulumi-terraform-bridge
             - A go version such as "v3.90.1"
             - A commit SHA in pulumi/pulumi such as "ac71ebc1d34e5ccfd1a7fed61e6ff43a3160f3cb"
        required: false
        type: string
        default: ""
      pr-reviewers:
        description: Reviewers to assign to the auto-opened pull request
        required: false
        type: string
        default: ""
      pr-description:
        description: Extra description to add to the auto-opened pull request
        required: false
        type: string
        default: ""
      pr-title-prefix:
        description: Prefix to add to the auto-opened pull request title
        required: false
        type: string
        default: ""
      automerge:
        description: Mark created PR for auto-merging?
        required: false
        type: boolean
        default: false
      patch-release:
        description: Whether to create a patch release
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write # For ESC secrets.

env:
  ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
  ARM_ENVIRONMENT: public
  ARM_LOCATION: westus2
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
  AWS_CORP_S3_UPLOAD_ACCESS_KEY_ID: ${{ secrets.AWS_CORP_S3_UPLOAD_ACCESS_KEY_ID }}
  AWS_CORP_S3_UPLOAD_SECRET_ACCESS_KEY: ${{ secrets.AWS_CORP_S3_UPLOAD_SECRET_ACCESS_KEY }}
  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
  PULUMI_API: https://api.pulumi-staging.io
  PULUMI_BOT_TOKEN: ${{ secrets.PULUMI_BOT_TOKEN }}
  PULUMI_GO_DEP_ROOT: ${{ github.workspace }}/..
  PULUMI_LOCAL_NUGET: ${{ github.workspace }}/nuget
  PULUMI_MISSING_DOCS_ERROR: "true"
  PULUMI_PROVIDER_AUTOMATION_TOKEN: ${{ secrets.PULUMI_PROVIDER_AUTOMATION_TOKEN }}
  RELEASE_BOT_ENDPOINT: ${{ secrets.RELEASE_BOT_ENDPOINT }}
  RELEASE_BOT_KEY: ${{ secrets.RELEASE_BOT_KEY }}
  S3_COVERAGE_BUCKET_NAME: ${{ secrets.S3_COVERAGE_BUCKET_NAME }}
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
  TF_APPEND_USER_AGENT: pulumi

jobs:
  upgrade_provider:
    name: upgrade-provider
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repo
      uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
      with:
        persist-credentials: false    
    - id: esc-secrets
      name: Map environment to ESC outputs
      uses: ./.github/actions/esc-action
    - name: Setup mise
      uses: jdx/mise-action@v3
      env:
        MISE_FETCH_REMOTE_VERSIONS_TIMEOUT: 30s
      with:
        version: 2025.11.6
        github_token: ${{ secrets.GITHUB_TOKEN }}
        # only saving the cache in the prerequisites job
        cache_save: false
    - name: Call upgrade provider action
      if: github.event_name == 'workflow_dispatch'
      uses: pulumi/pulumi-upgrade-provider-action@e247104aede3eb4641f48c8ad0ea9de9346f2457 # v0.0.18
      with:
        kind: ${{ inputs.kind }}
        email: bot@pulumi.com
        username: pulumi-bot
        automerge: ${{ inputs.automerge }}
        target-bridge-version: ${{ inputs.target-bridge-version }}
        target-pulumi-version: ${{ inputs.target-pulumi-version }}
        pr-reviewers: ${{ inputs.pr-reviewers }}
        pr-description: ${{ inputs.pr-description }}
        pr-title-prefix: ${{ inputs.pr-title-prefix }}
        patch-release: ${{ github.event.client_payload.patch-release }}
      env:
        GH_TOKEN: ${{ steps.esc-secrets.outputs.PULUMI_PROVIDER_AUTOMATION_TOKEN || steps.esc-secrets.outputs.PULUMI_BOT_TOKEN || secrets.GITHUB_TOKEN }}
    - name: Call upgrade provider action
      if: github.event_name == 'repository_dispatch'
      uses: pulumi/pulumi-upgrade-provider-action@e247104aede3eb4641f48c8ad0ea9de9346f2457 # v0.0.18
      with:
        kind: ${{ github.event.client_payload.kind || 'bridge' }}
        email: bot@pulumi.com
        username: pulumi-bot
        automerge: ${{ github.event.client_payload.automerge }}
        target-pulumi-version: ${{ github.event.client_payload.target-pulumi-version }}
        target-bridge-version: ${{ github.event.client_payload.target-bridge-version }}
        pr-reviewers: ${{ github.event.client_payload.pr-reviewers }}
        pr-description: ${{ github.event.client_payload.pr-description }}
        pr-title-prefix: ${{ github.event.client_payload.pr-title-prefix }}
        patch-release: ${{ github.event.client_payload.patch-release }}
      env:
        GH_TOKEN: ${{ steps.esc-secrets.outputs.PULUMI_PROVIDER_AUTOMATION_TOKEN || steps.esc-secrets.outputs.PULUMI_BOT_TOKEN || secrets.GITHUB_TOKEN }}
